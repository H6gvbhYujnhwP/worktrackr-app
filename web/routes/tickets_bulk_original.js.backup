// BACKUP OF ORIGINAL BULK UPDATE ENDPOINT
// Lines 355-476 from tickets.js

router.put('/bulk', async (req, res) => {
  console.log('ğŸš¨ğŸš¨ğŸš¨ BULK UPDATE ENDPOINT HIT!');
  console.log('ğŸ“¦ Full request body:', JSON.stringify(req.body, null, 2));
  console.log('ğŸ“¦ Body keys:', Object.keys(req.body));
  console.log('ğŸ“¦ Body.ids:', req.body.ids);
  console.log('ğŸ“¦ Body.updates:', req.body.updates);
  console.log('ğŸ“¦ Body.updates type:', typeof req.body.updates);
  console.log('ğŸ“¦ Body.updates keys:', req.body.updates ? Object.keys(req.body.updates) : 'UNDEFINED');
  console.log('ğŸ“¦ Body.updates.priority:', req.body.updates?.priority);
  console.log('ğŸ“¦ Body.updates.status:', req.body.updates?.status);
  
  try {
    const { organizationId } = req.orgContext;
    const { ids, updates } = req.body;
    
    console.log('ğŸ“¦ After destructuring - ids:', ids);
    console.log('ğŸ“¦ After destructuring - updates:', updates);
    console.log('ğŸ“¦ After destructuring - updates type:', typeof updates);
    console.log('ğŸ“¦ After destructuring - updates keys:', updates ? Object.keys(updates) : 'UNDEFINED');

    if (!ids || !Array.isArray(ids) || ids.length === 0) {
      return res.status(400).json({ error: 'ids array is required' });
    }

    if (!updates || typeof updates !== 'object') {
      return res.status(400).json({ error: 'updates object is required' });
    }

    // Validate updates against schema (partial)
    console.log('ğŸ” Bulk update request:', { ids, updates });
    console.log('ğŸ” Raw updates object:', updates);
    console.log('ğŸ” Raw updates.priority:', updates.priority);
    console.log('ğŸ” Raw updates.status:', updates.status);
    let validatedUpdates;
    try {
      validatedUpdates = updateTicketSchema.partial().parse(updates);
      console.log('âœ… Validation passed:', validatedUpdates);
      console.log('âœ… Validated updates keys:', Object.keys(validatedUpdates));
      console.log('âœ… Validated updates.priority:', validatedUpdates.priority);
      console.log('âœ… Validated updates.status:', validatedUpdates.status);
    } catch (validationError) {
      console.error('âŒ Validation failed:', validationError);
      return res.status(400).json({ error: 'Validation failed', details: validationError.errors });
    }

    // Build SET clause dynamically
    const setClauses = [];
    const values = [];
    let paramCount = 1;

    if (validatedUpdates.title !== undefined) {
      setClauses.push(`title = $${paramCount++}`);
      values.push(validatedUpdates.title);
    }
    if (validatedUpdates.description !== undefined) {
      setClauses.push(`description = $${paramCount++}`);
      values.push(validatedUpdates.description);
    }
    if (validatedUpdates.status !== undefined) {
      setClauses.push(`status = $${paramCount++}`);
      values.push(validatedUpdates.status);
    }
    if (validatedUpdates.priority !== undefined) {
      setClauses.push(`priority = $${paramCount++}`);
      values.push(validatedUpdates.priority);
    }
    // Support both camelCase and snake_case for assignee_id
    const assigneeValue = validatedUpdates.assignee_id !== undefined ? validatedUpdates.assignee_id : validatedUpdates.assigneeId;
    if (assigneeValue !== undefined) {
      setClauses.push(`assignee_id = $${paramCount++}`);
      values.push(assigneeValue);
    }
    if (validatedUpdates.sector !== undefined) {
      setClauses.push(`sector = $${paramCount++}`);
      values.push(validatedUpdates.sector);
    }
    if (validatedUpdates.scheduled_date !== undefined) {
      setClauses.push(`scheduled_date = $${paramCount++}`);
      values.push(validatedUpdates.scheduled_date);
    }
    if (validatedUpdates.scheduled_duration_mins !== undefined) {
      setClauses.push(`scheduled_duration_mins = $${paramCount++}`);
      values.push(validatedUpdates.scheduled_duration_mins);
    }

    setClauses.push('updated_at = NOW()');
    
    console.log('ğŸ“¦ SET clauses built:', setClauses);
    console.log('ğŸ“¦ SET clauses length:', setClauses.length);
    console.log('ğŸ“¦ Values array:', values);

    if (setClauses.length === 1) {
      console.log('âŒ NO VALID FIELDS TO UPDATE! Only updated_at was set.');
      console.log('âŒ validatedUpdates was:', validatedUpdates);
      return res.status(400).json({ error: 'No valid fields to update' });
    }

    // Add organization ID and IDs to values
    values.push(organizationId);
    const orgIdParam = paramCount++;
    values.push(ids);
    const idsParam = paramCount;

    const updateQuery = `
      UPDATE tickets
      SET ${setClauses.join(', ')}
      WHERE organisation_id = $${orgIdParam}
        AND id = ANY($${idsParam}::uuid[])
    `;

    const result = await query(updateQuery, values);

    res.json({ updated: result.rowCount });

  } catch (error) {
    console.error('Bulk update error:', error);
    if (error instanceof z.ZodError) {
      return res.status(400).json({ error: 'Invalid input', details: error.errors });
    }
    res.status(500).json({ error: 'Failed to bulk update tickets' });
  }
});
